---
import { readFileSync, existsSync } from "fs";
import { resolve } from "path";

const { version = "latest", component, project = "style" } = Astro.props;

const route = `/hx/ec/${version}/${project}/${component.replace(".", "/")}`;

let preview = "";
let lines = 0;

const basePath = resolve(
  "src",
  "snippets",
  version,
  project,
  component.replace(".", "/"),
);

const codePath = resolve(basePath, "code.html");
const previewPath = resolve(basePath, "code.preview.html");

// Define available clipboard variants (code.html/FS is always available)
const clipboardVariants = [
  {
    key: "tw",
    label: "TW",
    tooltip: "Copy Tailwind CSS",
    file: "code.tw.html",
  },
  // Add more variants here in the future, e.g.:
  // { key: "bs", label: "BS", tooltip: "Copy Bootstrap", file: "code.bs.html" },
];

// Check which clipboard variants exist
const availableClipboards = clipboardVariants.filter((variant) =>
  existsSync(resolve(basePath, variant.file)),
);

try {
  // Always read code.html for line count
  const codeContent = readFileSync(codePath, "utf-8");
  lines = codeContent.trim().split("\n").length || 1;

  // Use code.preview.html if it exists, otherwise fall back to code.html content
  preview = existsSync(previewPath)
    ? readFileSync(previewPath, "utf-8")
    : codeContent;
} catch (error) {
  const componentPath = component.replace(".", "/");
  console.error(`Error reading files for ${componentPath}:`, error);
}
---

<div class="snippet mt relative" style="--mt: 10">
  <ul class="uk-tab" data-uk-tab="swiping: false">
    <li class="uk-active">
      <a href="#" style="--uk-tab-item-padding: 0.5rem 1rem 0.75rem 1rem"
        >Preview</a
      >
    </li>
    <li>
      <a href="#" style="--uk-tab-item-padding: 0.5rem 1rem 0.75rem 1rem"
        >Markup</a
      >
    </li>
  </ul>

  <ul
    class="uk-switcher mt border-b/o border-b-w"
    style="--mt: 6; --border-b: var(--uk-border); --border-b-o: var(--uk-border-o); --border-b-w: 1px;"
  >
    <li class="uk-active">
      <div class="pt pb" style="--pt: 6; --pb: 10;" set:html={preview} />
    </li>
    <li>
      <div class="mt ec" style="--mt: 6">
        <div
          class="bg/o animate-pulse"
          hx-trigger="intersect"
          hx-get={`${route}/markup`}
          hx-select="figure"
          hx-swap="outerHTML"
          style={`--bg: var(--uk-muted); --bg-o: var(--uk-muted-o); height: calc(calc(var(--ec-codeLineHt) * ${lines}) + calc(var(--ec-codePadBlk) * 2) + calc(var(--ec-brdWd) * 2))`}
        >
        </div>
      </div>
    </li>
  </ul>

  <div
    class="uk-button-group absolute [top] right display-hidden md:display-flex"
    style="--top: 9px; --right: 0"
  >
    <!-- Frankenstyle button (always present) -->
    <button
      type="button"
      class="uk-button uk-button-default uk-button-xsmall"
      data-uk-tooltip="Copy Frankenstyle"
      x-data
      x-on:click={`copyPreview('${route}/clipboard')`}
    >
      <uk-icon class="size" style="--size: 4" icon="copy"></uk-icon>
      FS
    </button>

    <!-- Dynamic clipboard variant buttons -->
    {
      availableClipboards.map((variant) => (
        <button
          type="button"
          class="uk-button uk-button-default uk-button-xsmall"
          data-uk-tooltip={variant.tooltip}
          x-data
          x-on:click={`copyPreview('${route}/clipboard_${variant.key}')`}
        >
          <uk-icon class="size" style="--size: 4" icon="copy" />
          {variant.label}
        </button>
      ))
    }

    <a
      class="uk-button uk-button-default uk-button-xsmall"
      data-uk-tooltip="Report an issue or submit a PR"
      href={`https://github.com/franken-ui/franken.style/tree/master/src/snippets/latest/${project}/${component.replace(".", "/")}`}
      target="_blank"
    >
      <uk-icon class="size" style="--size: 4" icon="bug-off"></uk-icon>
      PR
    </a>
  </div>
</div>
